<div class="page-content" *ngIf="package; else loading">
  <div class="page-header">
    <h1 class="page-title">Detalhes da Encomenda</h1>
    <button class="btn btn-secondary" (click)="goBack()">
      <i class="material-symbols-outlined">arrow_back</i> Voltar
    </button>
  </div>

  <div class="encomenda-details">
    <div class="encomenda-info">
      <div class="encomenda-header">
        <h2 class="encomenda-title">{{ package.trackingCode }}</h2>
        <div class="status-badge" [ngClass]="package.currentStatus | statusClass">
          {{ package.currentStatus | statusName }}
        </div>
      </div>

      <div class="encomenda-actions">
        <button *ngIf="
            package.currentStatus === PackageStatus.WAITING_ASSIGNMENT ||
            package.currentStatus === PackageStatus.RETURNED_WAREHOUSE ||
            package.currentStatus === PackageStatus.DELIVERY_ISSUES 
          " class="btn btn-primary" (click)="openAssignModal()">
          <i class="material-symbols-outlined">local_shipping</i> Atribuir Entregador
        </button>

        <button *ngIf="package.currentStatus === PackageStatus.WAITING_WITHDRAWAL" class="btn btn-primary"
          (click)="changeStatus(PackageStatus.WITH_COURIER)">
          <i class="material-symbols-outlined">check_circle</i> Confirmar Retirada
        </button>

        <button *ngIf="package.currentStatus === PackageStatus.WITH_COURIER" class="btn btn-primary"
          (click)="changeStatus(PackageStatus.OUT_FOR_DELIVERY)">
          <i class="material-symbols-outlined">directions_bike</i> Saída para Entrega
        </button>

        <button *ngIf="package.currentStatus === PackageStatus.OUT_FOR_DELIVERY" class="btn btn-primary"
          (click)="changeStatus(PackageStatus.DELIVERED)">
          <i class="material-symbols-outlined">done_all</i> Registrar Entrega
        </button>

        <button *ngIf="
            package.currentStatus === PackageStatus.OUT_FOR_DELIVERY ||
            package.currentStatus === PackageStatus.WITH_COURIER
          " class="btn btn-destructive" (click)="changeStatus(PackageStatus.RETURN_TO_WAREHOUSE_PENDING)">
          <i class="material-symbols-outlined">keyboard_return</i> Devolver
        </button>

        <button *ngIf="package.currentStatus === PackageStatus.RETURN_TO_WAREHOUSE_PENDING" class="btn btn-destructive"
          (click)="changeStatus(PackageStatus.RETURNED_WAREHOUSE)">
          <i class="material-symbols-outlined">assignment_return</i>Aceitar Devolução
        </button>

        <button *ngIf="package.currentStatus === PackageStatus.RETURNED_WAREHOUSE
        || package.currentStatus === PackageStatus.DELIVERY_ISSUES" class="btn btn-destructive"
          (click)="changeStatus(PackageStatus.RETURNED_SENDER)">
          <i class="material-symbols-outlined">assignment_return</i> Devolver ao Contratante
        </button>
        <button *ngIf="
            package.currentStatus === PackageStatus.WAITING_ASSIGNMENT ||
            package.currentStatus === PackageStatus.WAITING_WITHDRAWAL ||
            package.currentStatus === PackageStatus.WITH_COURIER ||
            package.currentStatus === PackageStatus.OUT_FOR_DELIVERY ||
            package.currentStatus === PackageStatus.RETURN_TO_WAREHOUSE_PENDING ||
            package.currentStatus === PackageStatus.RETURNED_WAREHOUSE" class="btn btn-destructive"
          (click)="changeStatus(PackageStatus.DELIVERY_ISSUES)">
          <i class="material-symbols-outlined">warning</i> Registrar Ocorrência
        </button>        
        <button class="btn btn-secondary" (click)="handleAddNote()">
          <i class="material-symbols-outlined">note_add</i> Adicionar Observação
        </button>
      </div>

      <div class="info-card" *ngIf="package.currentCourier">
        <h3 class="info-card-title">
          <i class="material-symbols-outlined">local_shipping</i> Entregador Responsável
        </h3>
        <div class="info-row">
          <div class="info-label">Nome:</div>
          <div class="info-value">{{ package.currentCourier.name }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Email:</div>
          <div class="info-value">{{ package.currentCourier.email }}</div>
        </div>
      </div>

      <div class="info-card">
        <h3 class="info-card-title">
          <i class="material-symbols-outlined">business</i> Parceiro Comercial
        </h3>
        <div class="info-row">
          <div class="info-label">Nome:</div>
          <div class="info-value">{{ package.partnerName }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Código:</div>
          <div class="info-value">{{ package.partnerCode }}</div>
        </div>
      </div>

      <div class="info-card">
        <h3 class="info-card-title">
          <i class="material-symbols-outlined">person</i> Destinatário
        </h3>
        <div class="info-row">
          <div class="info-label">Nome:</div>
          <div class="info-value">{{ package.recipientName }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Endereço:</div>
          <div class="info-value">{{ package.recipientAddress }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Cidade/UF:</div>
          <div class="info-value">{{ package.recipientCity }} / {{ package.recipientState }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Telefone:</div>
          <div class="info-value">{{ package.recipientPhone }}</div>
        </div>
      </div>

      <div class="info-card">
        <h3 class="info-card-title"><i class="material-symbols-outlined">inventory</i> Itens</h3>
        <table class="items-table">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Qtd.</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of package.items">
              <td>{{ item.description }}</td>
              <td>{{ item.quantity }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="history-timeline">
      <h3 class="timeline-title">Histórico de Atualizações</h3>

      <div class="timeline-item" *ngFor="let event of package.history">
        <div class="timeline-date">{{ event.actionDate | date : 'dd/MM/yyyy HH:mm' }}</div>
        <div class="timeline-content">
          <strong>{{ event.actionType }}</strong>
          <p *ngIf="event.notes" style="font-size: 13px; margin-top: 2px; color: var(--medium-gray)">
            {{ event.notes }}
          </p>
          <div *ngIf="event.statusSnapshot" class="timeline-status" [ngClass]="event.statusSnapshot | statusClass">
            {{ event.statusSnapshot | statusName }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" [class.show]="isAssignModalOpen">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Atribuir a Entregador</h3>
      <button class="modal-close" (click)="closeAssignModal()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Selecione o entregador:</label>
        <select [(ngModel)]="selectedCourierId" class="form-control">
          <option [ngValue]="null">Selecione...</option>
          <option *ngFor="let courier of couriers" [value]="courier.id">
            {{ courier.name }}
          </option>
        </select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeAssignModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="confirmAssignment()" [disabled]="!selectedCourierId">
        Confirmar
      </button>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="page-content" style="text-align: center; margin-top: 50px">
    <p>Carregando detalhes da encomenda...</p>
  </div>
</ng-template>